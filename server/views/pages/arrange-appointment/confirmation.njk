{% set phoneeNumber = case.mobileNumber %}

{% extends "../_form.njk" %}
{% set isRepeating = appointment.repeating == 'Yes' %}
{% set rearranging = appointment['rearrange-or-cancel'] %}
{% set buttonText = "Return to " + case.name.forename + "'s overview" %}
{% set notStandardForm = true %}
{% set appointmentDates = [appointment.date] %}
{% set phoneNumber = '' %}
{% if case.mobileNumber %}
    {% set phoneNumber = 'mobile' %}
{% endif %}
{% if not case.mobileNumber and case.telephoneNumber %}
    {% set phoneNumber = 'telephone' %}
{% endif %}
{% for appointmentDate in appointment.repeatingDates %}
    {% set appointmentDates = (appointmentDates.push(appointmentDate), appointmentDates) %}
{% endfor %}
{% set title = 'Appointment arranged' %}
{% set appointmentDatesHtml %}
    {% for appointmentDate in appointmentDates %}
        {% if loop.index > 1 %}<br>{% endif %}
        <span data-qa="appointment-date">{{ appointmentDate | dayOfWeek }}
            {{ appointmentDate | dateWithYear }}
    from
    {{ appointment.start }}
    to
    {{ appointment.end }}</span>
    {% endfor %}
    {% set cases = "/case/" %}
    {% set overViewLink = "/case/"+ crn %}
    {% set anotherAppointment = "/case/"+ crn + "/appointments/appointment/" + backendId + "/next-appointment"%}
{% endset %}

{% set panelHtml %}
    <div class="govuk-!-font-size-27">
        <strong>{{ appointment.type.description | toSentenceCase }}</strong><br/>
        {{ appointmentDatesHtml | safe }}
    </div>
{% endset %}

{% block beforeContent %}{% endblock %}
{% block primary %}
    {{ govukPanel({
        titleHtml: '<span data-qa="pageHeading">' + title + '</span>',
        html: panelHtml
    }) }}
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds" data-qa="what-happens-next">
        <h2 class="govuk-heading-m govuk-!-margin-top-6">What happens next</h2>
        <p class="govuk-body">
            You need to send
            {{case.name.forename}}
            the appointment details.


            {% if phoneNumber %}

            Their phone number is
            <span data-qa="{{ phoneNumber }}">
            {% if phoneNumber == 'mobile' %}{{ case.mobileNumber + "." }}
            {% else %}{{ case.telephoneNumber + "." }}
            {% endif %}</span>
        {% endif %}
        </p>
            {% if isOutLookEventFailed %}
                <p class="govuk-body" data-qa="outlook-err-msg-1">There is a technical problem with Outlook and we could not send you a calendar invitation.</p>
                <p class="govuk-body" data-qa="outlook-err-msg-2">The appointment has been added to the NDelius contact log and officer diary, along with any supporting information.</p>
            {% else %}
                <p>The appointment has been added to:</p>
                <ul class="govuk-list govuk-list--bullet" data-qa="outlook-msg">
                    <li>your calendar</li>
                    <li>the NDelius contact log and officer diary, along with any supporting information</li>
                </ul>
            {% endif %}
        <h2 class="govuk-heading-m govuk-!-margin-top-6">Further actions for {{case.name.forename}}</h2>
            <p>You can:</p>
            <ul class="govuk-list govuk-list--bullet">
                <li><a class="govuk-link" href="{{ anotherAppointment }}" data-qa="anotherAppointmentLink">
                        arrange another appointment
                    </a>
                </li>
            </ul>
    </div>
  </div>
  <form method="post" autocomplete="off" action="{{ paths.current  }}">
    <div class="govuk-button-group">
      {{ govukButton({
      html: buttonText,
      attributes: {
        'data-qa': 'submit-btn'
      }
    }) }}
      <a class="govuk-link" href="{{ cases }}" data-qa="returnToAllCases">
      Return to all cases
    </a>
    </div>
    <input type="hidden" name="_csrf" value="{{ csrfToken }}">
  </form>
{% endblock %}