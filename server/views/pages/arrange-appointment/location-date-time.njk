{% extends "../_form.njk" %}
{%- from "moj/components/date-picker/macro.njk" import mojDatePicker -%}
{%- from "moj/components/alert/macro.njk" import mojAlert -%}

{% set backLink = change if change else '/case/' + crn + '/arrange-appointment/' + id + '/attendance?back=attendance' %}
{% set disabilities = [] %}
{% set dependents = [] %}
{% set employments = [] %}
{% set relationship = '' %}
{% set provisions = [] %}
{% set riskToStaff = getStaffRisk(personRisks.riskFlags) %}
{% set personForename = case.name.forename %}

{% block heading %}
    {% set level = riskToStaff.levelDescription or riskToStaff.level %}
    {% if level and(level | upper == 'HIGH' or level | upper == 'MEDIUM') %}
        {% set html %}
        <a href="/case/{{ crn }}/risk/flag/{{ riskToStaff.id }}">View {{ personForename }}&apos;s risk to staff flag</a>
        {% endset %}
        {{ mojAlert({
    variant: "warning",
    title: personForename + " is " + riskLevelLabel(level) | lower + " risk to staff ",
    showTitleAsHeading: true,
    dismissible: false,
    html: html
}) }}
    {% endif %}
    <h3 class="govuk-heading-l" data-qa="pageHeading">Appointment date, time and location</h3>
{% endblock %}

{% for disability in case.disabilities.disabilities %}
    {% set disabilities = (disabilities.push(disability), disabilities) %}
{% endfor %}

{% for provision in case.provisions.provisions %}
    {% set provisions = (provisions.push(provision), provisions) %}
{% endfor %}

{% for circumstance in case.circumstances.circumstances %}
    {% if circumstance.type === 'Employment' %}
        {% set employments = (employments.push(circumstance.subType), employments) %}
    {% endif %}
    {% if circumstance.type === 'Dependents' %}
        {% set dependents = (dependents.push(circumstance.subType), dependents) %}
    {% endif %}
    {% if circumstance.type === 'Relationship' %}
        {% set relationship = circumstance.subType %}
    {% endif %}
{% endfor %}

{% set showCircumstances = disabilities.length > 0 or provisions.length > 0 or relationship or employments.length > 0 or dependents.length > 0 %}

{% if showCircumstances %}
    {% set circumstancesHTML %}
    <dl class="govuk-!-static-margin-0">
        {% if disabilities.length > 0 %}
            <div data-qa="disability">
                <dt class="govuk-body govuk-!-static-margin-bottom-1">
                    <p class="govuk-body govuk-!-font-weight-bold govuk-!-margin-bottom-0">Disability</p>
                </dt>
                <dd class="govuk-!-static-margin-left-0 govuk-!-static-margin-bottom-3">
                    {% for disability in disabilities %}
                        {% if loop.index > 1 %}<br>{% endif %}{{ disability }}
                    {% endfor %}
                </dd>
            </div>
        {% endif %}

        {% if provisions.length > 0 %}
            <div data-qa="provisions">
                <dt class="govuk-body govuk-!-static-margin-bottom-1">
                    <p class="govuk-body govuk-!-font-weight-bold govuk-!-margin-bottom-0">Reasonable adjustments</p>
                </dt>
                <dd class="govuk-!-static-margin-left-0 govuk-!-static-margin-bottom-3">
                    {% for provision in provisions %}
                        {% if loop.index > 1 %}<br>{% endif %}{{ provision }}
                    {% endfor %}
                </dd>
            </div>
        {% endif %}

        {% if relationship %}
            <div data-qa="relationship">
                <dt class="govuk-body govuk-!-static-margin-bottom-1">
                    <p class="govuk-body govuk-!-font-weight-bold govuk-!-margin-bottom-0">Relationship</p>
                </dt>
                <dd class="govuk-!-static-margin-left-0 govuk-!-static-margin-bottom-3">
                    {{ relationship }}
                </dd>
            </div>
        {% endif %}

        {% if employments.length > 0 %}
            <div data-qa="employment">
                <dt class="govuk-body govuk-!-static-margin-bottom-1">
                    <p class="govuk-body govuk-!-font-weight-bold govuk-!-margin-bottom-0">Employment</p>
                </dt>
                <dd class="govuk-!-static-margin-left-0 govuk-!-static-margin-bottom-3">
                    {% for employment in employments %}
                        {% if loop.index > 1 %}<br>{% endif %}{{ employment }}
                    {% endfor %}
                </dd>
            </div>
        {% endif %}

        {% if dependents.length > 0 %}
            <div data-qa="dependents">
                <dt class="govuk-body govuk-!-static-margin-bottom-1">
                    <p class="govuk-body govuk-!-font-weight-bold govuk-!-margin-bottom-0">Dependents</p>
                </dt>
                <dd class="govuk-!-static-margin-left-0 govuk-!-static-margin-bottom-0">
                    {% for dependent in dependents %}
                        {% if loop.index > 1 %}<br>{% endif %}{{ dependent }}
                    {% endfor %}
                </dd>
            </div>
        {% endif %}
    </dl>
    {% endset %}
{% endif %}

{% set locationItems = [] %}
{% for location in userLocations %}
    {% set locationItems = (locationItems.push({
    text: location.description | convertToTitleCase,
    value: location.code,
    attributes: {
    'data-qa': 'locationOption'
    }
}), locationItems) %}
{% endfor %}
{% if userLocations.length > 0 %}
    {% set locationItems = (locationItems.push({divider: 'or'}), locationItems) %}
{% endif %}
{% set locationItems = (locationItems.push({text: 'The location I’m looking for is not in this list', value: 'LOCATION_NOT_IN_LIST'}), locationItems) %}
{% if not appointment.type.isLocationRequired %}
    {% set locationItems = (locationItems.push({text: 'I do not need to pick a location', value: 'NO_LOCATION_REQUIRED'}), locationItems) %}
{% endif %}

{% block form %}
    {% if warningMessages %}
        <input type="hidden" name="_warningMessagesSeen" value="true">
        {{ mojAlert({
          variant: "warning",
          title: warningMessages.isWithinOneHourOfMeetingWith,
          dismissible: true,
          attributes: { "data-qa": "isWithinOneHourOfMeetingWithWarning"},
          html: warningMessages.isWithinOneHourOfMeetingWith
      }) if warningMessages.isWithinOneHourOfMeetingWith }}
        {{ mojAlert({
          variant: "warning",
          title: warningMessages.nonWorkingDayName,
          dismissible: true,
          attributes: { "data-qa": "nonWorkingDayNameWarning"},
          html: warningMessages.nonWorkingDayName
      }) if warningMessages.nonWorkingDayName }}
    {% endif %}
    {% if showCircumstances %}
        {{ govukDetails({
        summaryText: case.name.forename + "’s circumstances",
        html: circumstancesHTML
    }) }}
    {% endif %}
    <h3 class="govuk-heading-m">Enter the date and time of the appointment</h3>
    <div data-module="serviceAlert" class="display-none">
        {{ mojAlert({
  variant: "information",
  title: "You can only use this service to log attended and complied outcomes.",
  showTitleAsHeading: false,
  dismissible: true,
  html: 'You can only use this service to log attended and complied outcomes.<br><a href="#" target="_blank" rel="external noopener noreferrer">Use NDelius to arrange an appointment in the past with another outcome</a>.'
}) }}
    </div>
    <span data-qa="serviceAlertStatus" class="govuk-visually-hidden" aria-live="polite"></span>
    {{ mojDatePicker({
    label: {
        text: "Date"
    },
    hint: {
      text: "For example, 17/5/2024."
    },
    minDate: _minDate,
    maxDate: _maxDate
  } | decorateFormAttributes(['appointments', crn, id, 'date'])) }}

    {{ govukInput({
    label: {
    text: "Start time",
    classes: "govuk-label--s govuk-!-font-weight-regular"
    },
    hint: {
        text: "Use the 24-hour format, for example 09:30 or 16:30."
    },
    attributes: {
        size: 5,
        maxlength: 5
    },
    formGroup: {
    attributes: {
        'data-qa': 'startTime'
    }
    },
    classes: "govuk-input--width-3"
   } | decorateFormAttributes(['appointments', crn, id, 'start'])) }}

    {{ govukInput({
        label: {
        text: "End time",
        classes: "govuk-label--s govuk-!-font-weight-regular"
        },
        hint: {
            text: "Use the 24-hour format, for example 09:30 or 16:30."
        },
        attributes: {
            maxlength: 5,
            size: 5
        },
        formGroup: {
        attributes: {
            'data-qa': 'endTime'
        }
        },
        classes: "govuk-input--width-3"
     } | decorateFormAttributes(['appointments', crn, id, 'end'])) }}

    <input type="hidden" name="_minDate" value="{{_minDate}}">
    <input type="hidden" name="_maxDate" value="{{_maxDate}}">

    <h3 class="govuk-heading-m govuk-!-margin-bottom-0">Pick a location for this appointment</h3>
    {{ govukRadios({
    fieldset: {
      legend: {
        html: '<span data-qa="pageHeading">' + title | safe + '</span>',
        classes: "govuk-fieldset__legend--l govuk-!-margin-bottom-6",
        isPageHeading: false
      },
      attributes: {
        'data-qa': 'locationCode'
      }
    },
    items: locationItems
   } | decorateFormAttributes(['appointments', crn, id, 'user', 'locationCode'])) }}
{% endblock %}